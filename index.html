<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thread & Soul - Your Dress Business</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons for vector icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom CSS for finer control and animations */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .product-card, .collection-card, .cart-item, .checkout-form-container {
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .product-card:hover, .collection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* hover:shadow-xl */
        }
        .btn-primary {
            background-color: #ec4899; /* pink-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* rounded-full */
            font-weight: 600;
            transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #db2777; /* pink-600 */
            transform: scale(1.05);
        }
        .btn-secondary {
            background-color: #a78bfa; /* purple-400 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600;
            transition: background-color 0.3s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #8b5cf6; /* purple-500 */
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.75rem;
            padding: 2rem;
            width: 90%;
            max-width: 56rem; /* max-w-2xl equivalent */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideInUp 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col">

    <!-- Header -->
    <header class="bg-gradient-to-r from-pink-500 to-purple-600 text-white p-4 shadow-md rounded-b-xl">
        <div class="container mx-auto flex justify-between items-center flex-wrap">
            <h1 class="text-3xl font-extrabold font-serif tracking-wide">Thread & Soul</h1>
            <nav class="flex items-center space-x-4 mt-2 sm:mt-0">
                <button onclick="navigateTo('home')" class="flex items-center space-x-1 hover:text-gray-200 transition-colors p-2 rounded-lg hover:bg-white hover:bg-opacity-20">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Home</span>
                </button>
                <button onclick="navigateTo('collections')" class="flex items-center space-x-1 hover:text-gray-200 transition-colors p-2 rounded-lg hover:bg-white hover:bg-opacity-20">
                    <i data-lucide="shirt" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Collections</span>
                </button>
                <button onclick="navigateTo('about')" class="flex items-center space-x-1 hover:text-gray-200 transition-colors p-2 rounded-lg hover:bg-white hover:bg-opacity-20">
                    <i data-lucide="user" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">About Us</span>
                </button>
                <button onclick="navigateTo('contact')" class="flex items-center space-x-1 hover:text-gray-200 transition-colors p-2 rounded-lg hover:bg-white hover:bg-opacity-20">
                    <i data-lucide="phone" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Contact</span>
                </button>
                <button onclick="openCartModal()" class="relative p-3 bg-pink-700 hover:bg-pink-800 rounded-full transition-colors shadow-lg">
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    <span id="cart-item-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-root" class="flex-grow">
        <!-- Content will be injected here by JavaScript -->
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-10 rounded-t-xl shadow-inner">
        <div class="container mx-auto text-center">
            <p class="text-lg font-semibold">&copy; 2025 Thread & Soul. All rights reserved.</p>
            <p class="text-sm mt-2">Crafted with ❤️ for your elegance.</p>
            <div class="flex justify-center space-x-4 mt-4">
                <a href="#" class="text-gray-400 hover:text-white transition-colors">Privacy Policy</a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors">Terms of Service</a>
            </div>
        </div>
    </footer>

    <!-- Cart Modal Container -->
    <div id="cart-modal-container"></div>
    <!-- Message Box Container -->
    <div id="message-box-container"></div>


    <script type="module">
        // Ensure Lucide icons are rendered after the initial page load
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        // --- Data for Products ---
        const collectionsData = [
            {
                id: 'festive-collection',
                name: 'Festive Collection',
                description: 'Embrace the festive spirit with our vibrant collection.',
                image: 'https://placehold.co/400x300/FAD02E/ffffff?text=Festive+Collection',
                products: [
                    { id: 'f001', name: 'Emerald Green Anarkali', price: 7500, imageUrl: 'https://placehold.co/200x200/FAD02E/ffffff?text=Anarkali' },
                    { id: 'f002', name: 'Royal Blue Lehenga', price: 12000, imageUrl: 'https://placehold.co/200x200/FAD02E/ffffff?text=Lehenga' },
                    { id: 'f003', name: 'Pink Silk Saree', price: 9800, imageUrl: 'https://placehold.co/200x200/FAD02E/ffffff?text=Silk+Saree' },
                ],
            },
            {
                id: 'kerala-sarees',
                name: 'Traditional Kerala Sarees',
                description: 'Experience the elegance of traditional Kerala handloom.',
                image: 'https://placehold.co/400x300/A8DADC/ffffff?text=Kerala+Sarees',
                products: [
                    { id: 'k001', name: 'Kasavu Saree with Gold Border', price: 4500, imageUrl: 'https://placehold.co/200x200/A8DADC/ffffff?text=Kasavu' },
                    { id: 'k002', name: 'Mundum Neriyathum', price: 3200, imageUrl: 'https://placehold.co/200x200/A8DADC/ffffff?text=Mundum' },
                    { id: 'k003', name: 'Settumund with Embroidery', price: 5800, imageUrl: 'https://placehold.co/200x200/A8DADC/ffffff?text=Embroidery' },
                ],
            },
            {
                id: 'girls-festive',
                name: 'Girls\' Festive Collection',
                description: 'Adorable outfits for your little ones to shine.',
                image: 'https://placehold.co/400x300/FFC107/ffffff?text=Girls+Collection',
                products: [
                    { id: 'g001', name: 'Kids Pattu Pavadai', price: 2800, imageUrl: 'https://placehold.co/200x200/FFC107/ffffff?text=Pavadai' },
                    { id: 'g002', name: 'Girls Lehenga Choli Set', price: 3500, imageUrl: 'https://placehold.co/200x200/FFC107/ffffff?text=Lehenga+Choli' },
                    { id: 'g003', name: 'Ethnic Frock', price: 2200, imageUrl: 'https://placehold.co/200x200/FFC107/ffffff?text=Frock' },
                ],
            },
            {
                id: 'handloom-collection',
                name: 'Handloom Collection',
                description: 'Celebrate the artistry of traditional handloom weaves.',
                image: 'https://placehold.co/400x300/4CAF50/ffffff?text=Handloom+Collection',
                products: [
                    { id: 'h001', name: 'Cotton Handloom Saree', price: 3800, imageUrl: 'https://placehold.co/200x200/4CAF50/ffffff?text=Cotton+Saree' },
                    { id: 'h002', name: 'Linen Handloom Dress Material', price: 2500, imageUrl: 'https://placehold.co/200x200/4CAF50/ffffff?text=Linen+Material' },
                    { id: 'h003', name: 'Block Print Kurta Set', price: 4200, imageUrl: 'https://placehold.co/200x200/4CAF50/ffffff?text=Block+Print' },
                ],
            },
        ];

        // --- Global State Management ---
        let cart = JSON.parse(localStorage.getItem('threadSoulCart')) || [];
        let currentPage = 'home';
        let selectedCollection = null;
        let userId = localStorage.getItem('threadSoulUserId') || crypto.randomUUID(); // Generate unique ID if not exists
        localStorage.setItem('threadSoulUserId', userId); // Store for persistence across sessions

        // --- Configuration for WhatsApp ---
        // REPLACE THIS WITH THE ACTUAL PHONE NUMBER FOR YOUR BUSINESS (including country code, without + or leading zeros)
        const WHATSAPP_BUSINESS_NUMBER = "919876543210"; // Example: for India +91, use 919876543210


        // --- Utility Functions ---
        window.updateCartCount = function() { // Made global
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-item-count').textContent = totalItems;
            // Hide the cart count if 0 items, show otherwise
            const cartCountElement = document.getElementById('cart-item-count');
            if (totalItems === 0) {
                cartCountElement.classList.add('hidden');
            } else {
                cartCountElement.classList.remove('hidden');
            }
        }

        function saveCartToLocalStorage() {
            localStorage.setItem('threadSoulCart', JSON.stringify(cart));
        }

        window.showMessageBox = function(message, type = 'info') { // Made global
            const container = document.getElementById('message-box-container');
            const messageBox = document.createElement('div');
            messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-[1001] animate-fade-in-up`;

            if (type === 'success') {
                messageBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600');
            } else {
                messageBox.classList.add('bg-blue-600');
            }

            messageBox.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button class="ml-4 text-white opacity-75 hover:opacity-100" onclick="this.parentElement.parentElement.remove()">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
            container.appendChild(messageBox);
            lucide.createIcons(); // Render lucide icon for close button

            setTimeout(() => {
                messageBox.remove();
            }, 5000); // Message disappears after 5 seconds
        }

        // --- Cart Functions ---
        window.addToCart = function(product) { // Made global
            const existingItemIndex = cart.findIndex(item => item.id === product.id);
            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            saveCartToLocalStorage();
            updateCartCount();
            showMessageBox(`${product.name} added to cart!`, 'success');
        }

        window.removeFromCart = function(productId) { // Made global
            cart = cart.filter(item => item.id !== productId);
            saveCartToLocalStorage();
            updateCartCount();
            renderCartModalContent(); // Re-render cart content
        }

        window.updateQuantity = function(productId, newQuantity) { // Made global
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity = Math.max(1, parseInt(newQuantity));
            }
            saveCartToLocalStorage();
            updateCartCount();
            renderCartModalContent(); // Re-render cart content
        }

        window.clearCart = function() { // Made global
            cart = [];
            saveCartToLocalStorage();
            updateCartCount();
            renderCartModalContent(); // Re-render cart content
            showMessageBox("Cart cleared!", 'info');
        }

        // --- Page Rendering Functions ---
        window.renderHomePage = function() { // Made global
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <section class="text-center mb-12">
                        <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight">
                            Welcome to <span class="text-purple-600">Thread & Soul</span>
                        </h2>
                        <p class="text-lg text-gray-700 mt-4 max-w-2xl mx-auto">
                            Discover exquisite dresses, traditional sarees, and elegant festive wear crafted with passion and precision.
                        </p>
                        <button onclick="navigateTo('collections')" class="mt-8 px-8 py-4 bg-pink-500 text-white text-xl font-semibold rounded-full hover:bg-pink-600 transition-all transform hover:scale-105 shadow-xl">
                            Explore Collections
                        </button>
                    </section>

                    <section class="mb-12">
                        <h3 class="text-3xl font-bold text-gray-800 mb-8 text-center">Our Collections</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                            ${collectionsData.map(collection => `
                                <div class="collection-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden cursor-pointer transform hover:-translate-y-1"
                                     onclick="selectCollection('${collection.id}')">
                                    <img src="${collection.image}" alt="${collection.name}" class="w-full h-48 object-cover rounded-t-xl"
                                         onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/333333?text=Image+Not+Found';">
                                    <div class="p-4">
                                        <h3 class="text-xl font-bold text-gray-800 mb-2">${collection.name}</h3>
                                        <p class="text-gray-600 text-sm">${collection.description}</p>
                                        <button class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors w-full">
                                            View Collection
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <section class="text-center py-12 bg-purple-50 rounded-xl shadow-inner">
                        <h3 class="text-3xl font-bold text-gray-800 mb-4">Quality & Craftsmanship</h3>
                        <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                            At Thread & Soul, we believe in the magic of handcrafted elegance. Each piece is a testament to timeless beauty and superior quality.
                        </p>
                    </section>
                </div>
            `;
            lucide.createIcons();
        }

        window.renderCollectionsPage = function() { // Made global
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">All Collections</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                        ${collectionsData.map(collection => `
                            <div class="collection-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden cursor-pointer transform hover:-translate-y-1"
                                 onclick="selectCollection('${collection.id}')">
                                <img src="${collection.image}" alt="${collection.name}" class="w-full h-48 object-cover rounded-t-xl"
                                     onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/333333?text=Image+Not+Found';">
                                <div class="p-4">
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">${collection.name}</h3>
                                    <p class="text-gray-600 text-sm">${collection.description}</p>
                                    <button class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors w-full">
                                        View Collection
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.renderProductsPage = function() { // Made global
            const appRoot = document.getElementById('app-root');
            if (!selectedCollection) {
                appRoot.innerHTML = `
                    <div class="container mx-auto px-4 py-8 text-center text-red-600">
                        <p class="text-xl">No collection selected. Please go back to collections.</p>
                        <button onclick="navigateTo('collections')" class="mt-4 px-6 py-3 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition-colors">
                            View Collections
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            appRoot.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <button onclick="navigateTo('collections')" class="mb-6 flex items-center text-purple-600 hover:text-purple-800 transition-colors font-semibold">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Back to Collections
                    </button>
                    <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">${selectedCollection.name}</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        ${selectedCollection.products.map(product => `
                            <div class="product-card bg-white rounded-xl shadow-lg p-4 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300">
                                <img src="${product.imageUrl}" alt="${product.name}" class="w-48 h-48 object-cover rounded-lg mb-4 shadow-sm"
                                     onerror="this.onerror=null;this.src='https://placehold.co/200x200/cccccc/333333?text=Product';">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">${product.name}</h3>
                                <p class="text-purple-700 font-bold text-xl mb-4 flex items-center">
                                    <i data-lucide="indian-rupee" class="w-4 h-4 mr-1"></i>${product.price.toLocaleString('en-IN')}
                                </p>
                                <button onclick="addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')})"
                                        class="px-6 py-2 bg-pink-500 text-white rounded-full hover:bg-pink-600 transition-colors shadow-md hover:shadow-lg">
                                    Add to Cart
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.renderAboutPage = function() { // Made global
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">About Thread & Soul</h2>
                    <div class="bg-white rounded-xl shadow-lg p-8 max-w-3xl mx-auto text-gray-700 leading-relaxed text-lg">
                        <p class="mb-4">
                            Welcome to Thread & Soul, where tradition meets contemporary elegance. We are passionate about bringing you the finest selection of dresses,
                            from the vibrant hues of festive wear to the timeless grace of traditional Kerala sarees. Each piece in our collection is
                            curated with an eye for detail, quality craftsmanship, and a deep appreciation for textile artistry.
                        </p>
                        <p class="mb-4">
                            Our journey began with a simple vision: to offer unique and high-quality attire that celebrates individuality and cultural heritage.
                            We work closely with skilled artisans and weavers to ensure that every garment not only looks exquisite but also feels comfortable and lasts for years to come.
                        </p>
                        <p>
                            Thank you for choosing Thread & Soul. We hope you find something truly special that resonates with your style and spirit.
                        </p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.renderContactPage = function() { // Made global
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Contact Us</h2>
                    <div class="bg-white rounded-xl shadow-lg p-8 max-w-xl mx-auto text-gray-700 text-lg">
                        <p class="mb-4 text-center">
                            Have questions or need assistance? Feel free to reach out to us!
                        </p>
                        <div class="space-y-4">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="phone" class="w-6 h-6 text-purple-600"></i>
                                <span>Phone: +91 98765 43210</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <i data-lucide="mail" class="w-6 h-6 text-purple-600"></i>
                                <span>Email: info@threadandsoul.com</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <i data-lucide="map-pin" class="w-6 h-6 text-purple-600"></i>
                                <span>Address: 123 Fashion Lane, Kochi, Kerala, India</span>
                            </div>
                        </div>
                        <p class="mt-6 text-sm text-center text-gray-500">
                            (Note: Contact details are placeholders for demonstration.)
                        </p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        window.navigateTo = function(page) { // Made global
            currentPage = page;
            selectedCollection = null; // Reset selected collection when changing main pages
            renderCurrentPage();
        }

        window.selectCollection = function(collectionId) { // Made global
            selectedCollection = collectionsData.find(c => c.id === collectionId);
            currentPage = 'products';
            renderCurrentPage();
        }

        function renderCurrentPage() { // This is called internally, no need for window.
            switch (currentPage) {
                case 'home':
                    renderHomePage();
                    break;
                case 'collections':
                    renderCollectionsPage();
                    break;
                case 'products':
                    renderProductsPage();
                    break;
                case 'about':
                    renderAboutPage();
                    break;
                case 'contact':
                    renderContactPage();
                    break;
                default:
                    renderHomePage();
            }
        }

        // --- Cart Modal Functions ---
        let cartModalInstance = null;

        window.openCartModal = function() { // Made global
            console.log("openCartModal called."); // Diagnostic
            if (cartModalInstance) {
                closeCartModal(); // Ensure only one modal is open
            }

            const modalContainer = document.getElementById('cart-modal-container');
            cartModalInstance = document.createElement('div');
            cartModalInstance.className = `modal`;
            cartModalInstance.innerHTML = `
                <div class="modal-content w-full max-w-lg animate-slideInUp">
                    <button onclick="closeCartModal()" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Your Shopping Cart</h2>
                    <div id="cart-content"></div>
                    <div id="checkout-form-container"></div>
                </div>
            `;
            modalContainer.appendChild(cartModalInstance);
            lucide.createIcons(); // Render lucide icons within modal

            renderCartModalContent(); // Initial render of cart content
        }

        window.closeCartModal = function() { // Made global
            if (cartModalInstance) {
                cartModalInstance.remove();
                cartModalInstance = null;
            }
        }

        function renderCartModalContent() { // This is called internally, no need for window.
            const cartContentDiv = document.getElementById('cart-content');
            const checkoutFormContainer = document.getElementById('checkout-form-container');

            if (!cartContentDiv || !checkoutFormContainer) return; // Exit if modal elements aren't ready

            // Clear previous content
            cartContentDiv.innerHTML = '';
            checkoutFormContainer.innerHTML = '';

            if (cart.length === 0) {
                cartContentDiv.innerHTML = `<p class="text-gray-600 text-center text-lg">Your cart is empty.</p>`;
                checkoutFormContainer.innerHTML = `
                    <div class="flex justify-between mt-6 space-x-4">
                        <button onclick="clearCart()" disabled class="px-6 py-3 bg-gray-200 text-gray-800 rounded-full disabled:opacity-50 disabled:cursor-not-allowed flex-grow">
                            Clear Cart
                        </button>
                        <button disabled class="px-6 py-3 bg-purple-600 text-white rounded-full disabled:opacity-50 disabled:cursor-not-allowed flex-grow">
                            Proceed to Checkout
                        </button>
                    </div>
                `;
            } else {
                let cartItemsHtml = `
                    <div class="space-y-4 mb-6">
                        ${cart.map(item => `
                            <div class="cart-item flex items-center justify-between border-b pb-4 last:border-b-0">
                                <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 object-cover rounded-lg mr-4 shadow-sm"
                                     onerror="this.onerror=null;this.src='https://placehold.co/200x200/cccccc/333333?text=Product';">
                                <div class="flex-grow">
                                    <h4 class="font-semibold text-gray-700">${item.name}</h4>
                                    <p class="text-sm text-gray-500 flex items-center">
                                        <i data-lucide="indian-rupee" class="w-3.5 h-3.5 mr-0.5"></i>${item.price.toLocaleString('en-IN')} x ${item.quantity}
                                    </p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="number" min="1" value="${item.quantity}"
                                           onchange="updateQuantity('${item.id}', this.value)"
                                           class="w-16 p-2 border border-gray-300 rounded-lg text-center">
                                    <button onclick="removeFromCart('${item.id}')"
                                            class="p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                cartContentDiv.innerHTML = cartItemsHtml;
                lucide.createIcons(); // Render lucide icons for cart items

                const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                checkoutFormContainer.innerHTML = `
                    <div class="flex justify-between items-center text-xl font-bold text-gray-900 mt-6 pt-4 border-t border-gray-200">
                        <span>Total:</span>
                        <span class="flex items-center">
                            <i data-lucide="indian-rupee" class="w-5 h-5 mr-0.5"></i>${total.toLocaleString('en-IN')}
                        </span>
                    </div>
                    <div class="flex justify-between mt-6 space-x-4">
                        <button onclick="clearCart()" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300 transition-colors flex-grow">
                            Clear Cart
                        </button>
                        <button onclick="renderCheckoutForm()" class="px-6 py-3 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition-colors shadow-lg flex-grow">
                            Proceed to Order
                        </button>
                    </div>
                `;
            }
        }

        window.renderCheckoutForm = function() { // Made global
            const cartContentDiv = document.getElementById('cart-content');
            const checkoutFormContainer = document.getElementById('checkout-form-container');

            if (!cartContentDiv || !checkoutFormContainer) {
                console.error("Cart content or checkout form container not found for rendering.");
                return;
            }

            cartContentDiv.innerHTML = ''; // Clear cart view
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            const checkoutFormHtml = `
                <div class="p-4">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Your Order Details</h3>
                    <p class="text-sm text-gray-500 mb-4 text-center">
                        Your Order ID: <span class="font-mono bg-gray-100 p-1 rounded text-xs">${userId}</span>
                    </p>
                    <form id="checkout-form" class="space-y-4" novalidate>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="name" class="block text-gray-700 text-sm font-bold mb-1">Full Name</label>
                                <input type="text" id="name" name="name" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div>
                                <label for="email" class="block text-gray-700 text-sm font-bold mb-1">Email</label>
                                <input type="email" id="email" name="email" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                        </div>
                        <div>
                            <label for="phone" class="block text-gray-700 text-sm font-bold mb-1">Phone Number</label>
                            <input type="tel" id="phone" name="phone" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div>
                                <label for="address" class="block text-gray-700 text-sm font-bold mb-1">Delivery Address</label>
                                <textarea id="address" name="address" rows="3" required
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"></textarea>
                            </div>
                        </div>

                        <p id="order-status" class="text-center font-semibold mt-4"></p>

                        <button type="button" id="whatsapp-order-button" onclick="handleWhatsAppOrder(event)"
                            class="w-full py-3 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed text-lg font-semibold flex items-center justify-center">
                            <i data-lucide="whatsapp" class="w-6 h-6 mr-2"></i> WhatsApp Order (Total: <i data-lucide="indian-rupee" class="w-5 h-5 ml-2 mr-1"></i>${total.toLocaleString('en-IN')})
                        </button>
                        <p class="text-sm text-center text-gray-500 mt-2">
                            Clicking this will open WhatsApp with your order details.
                        </p>
                    </form>
                </div>
            `;
            checkoutFormContainer.innerHTML = checkoutFormHtml;
            lucide.createIcons();
        }

        window.handleWhatsAppOrder = async function(e) {
            if (e && e.preventDefault) {
                e.preventDefault();
            }

            const whatsappButton = document.getElementById('whatsapp-order-button');
            const orderStatusElement = document.getElementById('order-status');

            if (!whatsappButton || !orderStatusElement) {
                console.error("WhatsApp button or order status element not found.");
                return;
            }

            whatsappButton.disabled = true;
            whatsappButton.innerHTML = `<span class="loading-spinner mr-3"></span> Preparing WhatsApp message...`;
            orderStatusElement.textContent = '';

            const customerInfo = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
            };

            // Basic client-side validation
            if (!customerInfo.name || !customerInfo.email || !customerInfo.phone || !customerInfo.address) {
                orderStatusElement.textContent = 'Please fill in all required fields.';
                orderStatusElement.className = 'text-center font-semibold mt-4 text-red-600';
                whatsappButton.disabled = false;
                const currentTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                whatsappButton.innerHTML = `<i data-lucide="whatsapp" class="w-6 h-6 mr-2"></i> WhatsApp Order (Total: <i data-lucide="indian-rupee" class="w-5 h-5 ml-2 mr-1"></i>${currentTotal.toLocaleString('en-IN')})`;
                lucide.createIcons();
                return;
            }

            // Construct the WhatsApp message
            let message = `*New Order from Thread & Soul Website*%0A%0A`;
            message += `*Order ID:* ${userId}%0A`;
            message += `*Customer Details:*%0A`;
            message += `Name: ${customerInfo.name}%0A`;
            message += `Email: ${customerInfo.email}%0A`;
            message += `Phone: ${customerInfo.phone}%0A`;
            message += `Address: ${customerInfo.address}%0A%0A`;
            message += `*Ordered Items:*%0A`;

            cart.forEach((item, index) => {
                message += `${index + 1}. ${item.name} (Qty: ${item.quantity}) - ₹${item.price.toLocaleString('en-IN')}%0A`;
            });

            const totalAmount = cart.reduce((total, item) => total + item.price * item.quantity, 0);
            message += `%0A*Total Amount: ₹${totalAmount.toLocaleString('en-IN')}*%0A%0A`;
            message += `Please contact the customer to confirm the order and arrange payment.`;

            // --- DIAGNOSTIC LOGS ADDED HERE ---
            console.log("Constructed WhatsApp Message:");
            console.log(message);
            const whatsappUrl = `https://wa.me/${WHATSAPP_BUSINESS_NUMBER}?text=${encodeURIComponent(message)}`;
            console.log("Generated WhatsApp URL:");
            console.log(whatsappUrl);
            // --- END DIAGNOSTIC LOGS ---

            // Open WhatsApp
            window.open(whatsappUrl, '_blank');

            orderStatusElement.textContent = 'WhatsApp opened with your order details. Please send the message.';
            orderStatusElement.className = 'text-center font-semibold mt-4 text-green-600';

            // Clear cart after opening WhatsApp (assuming order is "sent" from user's perspective)
            clearCart();
            setTimeout(() => {
                closeCartModal();
            }, 3000); // Close modal after a few seconds

            whatsappButton.disabled = false;
            // Update button text to reflect new (empty) cart total
            const newTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0); // Should be 0 after clearCart
            whatsappButton.innerHTML = `<i data-lucide="whatsapp" class="w-6 h-6 mr-2"></i> WhatsApp Order (Total: <i data-lucide="indian-rupee" class="w-5 h-5 ml-2 mr-1"></i>${newTotal.toLocaleString('en-IN')})`;
            lucide.createIcons();
        };


        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateCartCount();
            renderCurrentPage();
        });
    </script>
</body>
</html>
